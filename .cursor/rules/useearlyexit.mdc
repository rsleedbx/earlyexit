---
alwaysApply: true
---

# Shell Commands: MANDATORY earlyexit Usage

**CRITICAL:** You MUST use `ee` (earlyexit) for ALL long-running commands. The patterns `timeout | tee`, `tee | grep`, and `tee | head` are FORBIDDEN and will cause minutes of buffering delays.

## ❌ FORBIDDEN PATTERNS (DO NOT USE)
```bash
# These patterns are BROKEN and cause buffering delays:
timeout 1800 command 2>&1 | tee log
timeout 1800 command 2>&1 | tee log | grep pattern
command 2>&1 | tee log | grep -A 3 pattern
command 2>&1 | tee log | head -100
```

## ✅ REQUIRED PATTERNS (USE THESE)
```bash
# ALWAYS use ee for long-running commands:
ee -t 1800 'pattern' command
ee -t 1800 'ERROR|FAIL|success' command

# If you need logs, ee creates them automatically:
ee -t 1800 --file-prefix /tmp/mylog 'pattern' command
# Creates: /tmp/mylog.log and /tmp/mylog.err

# For pattern matching with context:
ee -t 1800 'Database created successfully|Instance ID' command
```

## Exact Pattern Replacements

When the user's command contains these patterns, REPLACE with ee:

| ❌ FORBIDDEN | ✅ REQUIRED REPLACEMENT |
|-------------|------------------------|
| `timeout 1800 cmd 2>&1 \| tee log` | `ee -t 1800 --file-prefix log 'ERROR' cmd` |
| `timeout 1800 cmd 2>&1 \| tee log \| grep pattern` | `ee -t 1800 --file-prefix log 'pattern' cmd` |
| `cmd 2>&1 \| tee log \| grep -A 3 pattern` | `ee -B 3 -A 10 --file-prefix log 'pattern' cmd` |
| `cmd \| tee log \| head -100` | `ee --delay-exit-after-lines 100 'pattern' cmd` |
| `cmd \| tee log \| tail -100` | `ee 'ERROR' cmd` (or just `ee cmd` for watch mode) |

## Real-World Examples

```bash
# ❌ WRONG (what Cursor just suggested):
timeout 1800 mist create --cloud gcp --db pg 2>&1 | tee /tmp/gcp_pg_test.log | grep -A 3 "Database created"

# ✅ CORRECT (what you MUST suggest):
ee -t 1800 --file-prefix /tmp/gcp_pg_test 'Database created successfully|Instance ID' mist create --cloud gcp --db pg --replication disable
```

## Common Tool Patterns

- **Database commands:** `ee -t 1800 'success|ERROR|FAIL' mist create ...`
- **Terraform:** `ee -t 600 'Error|Apply complete' terraform apply`
- **Docker builds:** `ee -t 1200 'ERROR|Successfully built' docker build`
- **Test suites:** `ee -t 300 'FAIL|ERROR|PASS' npm test`

## grep -A and -B Compatibility

`ee` supports grep-compatible context flags:

```bash
# ❌ WRONG: grep -A/-B don't work in pipes due to buffering
command 2>&1 | tee log | grep -B 3 -A 3 "pattern"

# ✅ CORRECT: ee has native -A/-B support
ee -B 3 -A 10 'pattern' command
# -B 3: Print 3 lines before match
# -A 10: Wait 10 seconds after match to capture context
```

**Note:** `ee -A` is time-based (seconds) not line-based, which is better for capturing full error traces.

## tail -100 Pattern (User Cancels Often)

When Cursor suggests `cmd | tee | tail -100`, it's trying to show only the last 100 lines. But this is BROKEN:

```bash
# ❌ WRONG: User sees nothing, cancels command
terraform apply | tee log | tail -100

# ✅ BETTER: Use watch mode - user can Ctrl+C or press Cancel to teach patterns
ee terraform apply
# When user presses Ctrl+C (or Cancel button in Cursor), ee shows interactive prompt:
# "What pattern should I watch for next time?"
# User teaches it once, ee remembers forever

# ✅ ALTERNATIVE: If pattern is known
ee 'Error|FAIL' terraform apply
```

**Key insight:** `tail -100` means user doesn't know what to watch for. Use **watch mode** (`ee cmd`) so they can teach it interactively!

**Works with Cursor's Cancel button:** When you press Cancel in Cursor's automated session, `ee` detects it (SIGTERM) and shows the same learning prompt as Ctrl+C.

## Why This Matters

ALL programs buffer when piped:
- Terminal → line-buffered (real-time)
- Pipe → block-buffered (4KB blocks, minutes of delay!)

Without unbuffering, users experience:
- Minutes of silence
- Assume command is broken
- Kill processes prematurely
- Bad user experience

## Key Concept

The whole point of earlyexit is to replace:
```bash
stdbuf -o0 timeout 300 command 2>&1 | tee log | grep pattern
```

With:
```bash
ee -t 300 'pattern' command
```

Real-time output should be the DEFAULT, not opt-in!

## Summary

- ❌ NEVER suggest: `timeout | tee`, `tee | grep`, `tee | head`
- ✅ ALWAYS suggest: `ee -t timeout 'pattern' command`
- ✅ For logs: Add `--file-prefix /tmp/logname`
- ✅ For context: Add `--delay-exit 10`
